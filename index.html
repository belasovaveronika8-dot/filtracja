<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#eef6ff" />
  <title>Filtracja ‚Äî Zbuduj filtr</title>

  <style>
    :root{
      --bg:#eef6ff;
      --bg2:#f8fbff;
      --card:#ffffff;
      --line:#cfe0f2;
      --text:#0f172a;
      --muted:#475569;
      --accent:#0ea5a4;
      --accent2:#0284c7;
      --bad:#e11d48;
      --shadow: 0 12px 30px rgba(2,132,199,.12);
      --r:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(2,132,199,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 85%, rgba(14,165,164,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      display:flex;
      overflow-x:hidden; /* FIX: –∑–∞–ø—Ä–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ */
    }

    /* FIX: –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥ iOS/Telegram */
    .app{
      margin:auto;
      width:100%;
      max-width:520px;
      padding:16px 0 calc(16px + env(safe-area-inset-bottom)) 0;
      overflow-x:hidden;
    }

    /* FIX: –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑—ä–µ–∑–∂–∞–ª–æ—Å—å */
    h1, p, div, span{
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .header{
      padding:0 16px;
      margin-bottom:12px;
    }
    h1{
      margin:0 0 6px 0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.35;
    }

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
      margin:0 16px 12px 16px;
      backdrop-filter: blur(6px);
      overflow:hidden; /* FIX: –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–ª–µ–∑–∞–µ—Ç –Ω–∞—Ä—É–∂—É */
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      min-width:0; /* FIX */
    }

    .pill{
      background:rgba(238,246,255,.9);
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      font-size:13px;
      color:var(--text);
      user-select:none;
      max-width:100%;
      min-width:0; /* FIX */
    }
    .pill b{ font-variant-numeric:tabular-nums; }

    .sectionTitle{
      margin:10px 0 8px 0;
      font-size:14px;
      font-weight:800;
      color:var(--text);
    }
    .hint{
      margin:0 0 10px 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    /* FIX: —Å–µ—Ç–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è, —Å–∂–∞—Ç–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ */
    .choices{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      min-width:0;
    }

    .chip{
      border:1px solid rgba(2,132,199,.22);
      background:rgba(238,246,255,.72);
      border-radius:14px;
      padding:12px;
      cursor:pointer;
      text-align:left;
      user-select:none;
      -webkit-tap-highlight-color: transparent;

      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;

      min-width:0;      /* FIX */
      max-width:100%;   /* FIX */
    }
    .chip:active{ transform: translateY(1px); }
    .chip .left{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0; /* FIX */
    }
    .chip .ico{
      width:38px; height:38px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      background:#fff;
      border:1px solid rgba(2,132,199,.18);
      flex:0 0 auto;
    }
    .chip .name{
      font-weight:800;
      font-size:14px;
      line-height:1.15;
    }
    .chip .desc{
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
      line-height:1.2;
    }
    .chip .tag{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(2,132,199,.18);
      background:rgba(255,255,255,.8);
      border-radius:999px;
      padding:4px 8px;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .chip.disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .stack{
      margin-top:10px;
      border:1px solid rgba(2,132,199,.18);
      background:rgba(255,255,255,.75);
      border-radius:16px;
      padding:12px;
      overflow:hidden; /* FIX */
    }
    .stackTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;   /* FIX: –ø–µ—Ä–µ–Ω–æ—Å */
      min-width:0;
    }
    .stackTop .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }

    .slots{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .slot{
      border:1px dashed rgba(2,132,199,.30);
      background:rgba(238,246,255,.55);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      min-height:44px;
      font-size:14px;
      gap:10px;
      min-width:0;
    }
    .slot span{ min-width:0; }
    .slot b{ font-weight:900; }
    .slot .remove{
      border:none;
      background:transparent;
      color:var(--bad);
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      padding:6px 8px;
      border-radius:10px;
      flex:0 0 auto;
    }
    .slot .remove:active{ background:rgba(225,29,72,.08); }

    .meter{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(2,132,199,.18);
      background:rgba(255,255,255,.78);
      padding:12px;
      overflow:hidden; /* FIX */
    }

    /* Symulacja wody */
    .waterBox{
      border:1px solid rgba(2,132,199,.18);
      border-radius:16px;
      background:rgba(238,246,255,.45);
      padding:12px;
      margin-bottom:10px;
      overflow:hidden;
    }
    .waterTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap; /* FIX */
      min-width:0;
    }
    .waterTop .title{
      font-weight:900;
      font-size:14px;
      margin:0;
    }
    .waterTop .mini{
      color:var(--muted);
      font-size:12px;
      line-height:1.25;
      text-align:right;
      margin:0;
    }

    .beaker{
      position:relative;
      height:140px;
      border-radius:18px;
      border:1px solid rgba(2,132,199,.20);
      background: rgba(255,255,255,.7);
      overflow:hidden;
      max-width:100%;
    }
    .beaker::before{
      content:"";
      position:absolute;
      inset:10px;
      border-radius:14px;
      border:1px dashed rgba(2,132,199,.20);
      pointer-events:none;
    }
    .water{
      position:absolute;
      left:0; right:0; bottom:0;
      height:72%;
      background: linear-gradient(180deg, rgba(2,132,199,.22), rgba(14,165,164,.10));
    }
    .mud{
      position:absolute;
      inset:0;
      background:
        radial-gradient(700px 240px at 30% 20%, rgba(160,120,60,.55), transparent 55%),
        radial-gradient(600px 220px at 70% 30%, rgba(140,110,70,.50), transparent 55%),
        linear-gradient(180deg, rgba(120,90,55,.55), rgba(120,90,55,.20));
      opacity: 1;
      transition: opacity 1.2s ease;
    }
    .pour{
      position:absolute;
      top:-30px; left:50%;
      width:16px; height:0;
      transform:translateX(-50%);
      border-radius:999px;
      background: rgba(120,90,55,.55);
      opacity:0;
    }
    .beaker.pouring .pour{
      opacity:1;
      animation: pour 0.55s ease-in-out forwards;
    }
    @keyframes pour{
      0%{ height:0; }
      60%{ height:170px; }
      100%{ height:170px; opacity:0; }
    }

    .bar{
      height:12px;
      background:rgba(15,23,42,.08);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(2,132,199,.18);
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width .45s ease;
    }
    .meterRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      margin-top:8px;
      flex-wrap:wrap; /* FIX */
      min-width:0;
    }
    .meterRow .big{
      font-weight:1000;
      font-size:18px;
    }
    .meterRow .note{
      color:var(--muted);
      font-size:12px;
      line-height:1.25;
      text-align:right;
    }

    .btnRow{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .btn{
      flex:1;
      min-width: 140px;
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:15px;
      cursor:pointer;
      color:#fff;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 12px 24px rgba(2,132,199,.14);
      -webkit-tap-highlight-color: transparent;
    }
    .btn.secondary{
      background:#fff;
      color:var(--text);
      border:1px solid var(--line);
      box-shadow:none;
      font-weight:800;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      background: rgba(15,23,42,.28);
    }
    .modal.show{ display:flex; }
    .sheet{
      width:100%;
      max-width:560px;
      background: rgba(255,255,255,.97);
      border:1px solid rgba(2,132,199,.22);
      border-radius:18px;
      box-shadow: 0 18px 40px rgba(2,132,199,.18);
      padding:14px;
    }
    .sheet h2{ margin:0 0 8px 0; font-size:16px; }
    .sheet p, .sheet li{ color:var(--muted); font-size:13px; line-height:1.35; }
    .sheet ul{ margin:8px 0 10px 18px; padding:0; }
    .warn{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(225,29,72,.25);
      background: rgba(255,241,242,.85);
      color:#7f1d1d;
      font-size:13px;
      line-height:1.35;
      font-weight:700;
    }

    /* FIX: –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ ‚Äî –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞, —á—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ ‚Äú–≤—ã–ª–µ—Ç–∞–ª–æ‚Äù */
    @media (max-width: 520px){
      .choices{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1>Filtracja ‚Äî Zbuduj filtr</h1>
      <p class="sub">U≈Ç√≥≈º warstwy filtra w dobrej kolejno≈õci. Nastƒôpnie ‚ÄûSprawd≈∫‚Äù i ‚ÄûWlej wodƒô‚Äù, aby zobaczyƒá efekt klarowania.</p>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill">üß± Warstwy wybrane: <b id="pickedCount">0</b>/3</div>
        <div class="pill">üíß Klarowno≈õƒá: <b id="clarityNum">0</b>/100</div>
      </div>

      <div class="sectionTitle">1) Wybierz 3 warstwy (od do≈Çu do g√≥ry)</div>
      <p class="hint">Klikaj warstwy w kolejno≈õci, w jakiej powinny znale≈∫ƒá siƒô w kolumnie filtracyjnej. Potem kliknij ‚ÄûSprawd≈∫‚Äù.</p>

      <div class="choices" id="choices"></div>

      <div class="stack">
        <div class="stackTop">
          <div>
            <div class="sectionTitle" style="margin:0">Twoja kolumna (d√≥≈Ç ‚Üí g√≥ra)</div>
            <div class="small">Mo≈ºesz usunƒÖƒá warstwƒô przyciskiem ‚úï.</div>
          </div>
          <div class="pill">Cel: ≈ºwir ‚Üí piasek ‚Üí wƒôgiel</div>
        </div>

        <div class="slots" id="slots"></div>

        <div class="meter">
          <div class="waterBox">
            <div class="waterTop">
              <p class="title">2) Symulacja: brudna woda ‚Üí czystsza</p>
              <p class="mini">Kliknij ‚ÄûWlej wodƒô‚Äù po sprawdzeniu filtra.</p>
            </div>
            <div class="beaker" id="beaker" aria-label="Symulacja wody">
              <div class="pour"></div>
              <div class="water">
                <div class="mud" id="mud"></div>
              </div>
            </div>
          </div>

          <div class="bar"><div class="fill" id="fill"></div></div>
          <div class="meterRow">
            <div class="big" id="resultTitle">Zbuduj filtr</div>
            <div class="note" id="resultNote">Wynik pojawi siƒô po ‚ÄûSprawd≈∫‚Äù.</div>
          </div>

          <div class="btnRow">
            <button class="btn secondary" id="resetBtn">Wyczy≈õƒá</button>
            <button class="btn" id="checkBtn" disabled>Sprawd≈∫</button>
            <button class="btn" id="pourBtn" disabled>Wlej wodƒô</button>
            <button class="btn secondary" id="howBtn">Instrukcja mini-filtra</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:0">
      <div class="sectionTitle">Co robiƒÖ warstwy?</div>
      <p class="hint" style="margin:0">
        <b>≈ªwir</b> zatrzymuje wiƒôksze zanieczyszczenia (li≈õcie, kamyki).<br/>
        <b>Piasek</b> wy≈Çapuje drobniejsze czƒÖstki (mu≈Ç, zawiesiny).<br/>
        <b>Wƒôgiel aktywny</b> ogranicza zapach i czƒô≈õƒá zwiƒÖzk√≥w barwiƒÖcych.
      </p>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="sheet">
      <h2>Instrukcja mini-filtra (pokaz)</h2>
      <p><b>Materia≈Çy:</b> butelka 1‚Äì2 l, wata/filtr do kawy/gaza, ≈ºwir, piasek, wƒôgiel aktywny, kubek/s≈Çoik.</p>
      <ul>
        <li>Odetnij dno butelki i odwr√≥ƒá jƒÖ jak lejek.</li>
        <li>Na szyjkƒô w≈Ç√≥≈º watƒô/filtr (≈ºeby warstwy nie wypada≈Çy).</li>
        <li>Wsyp warstwy: <b>≈ºwir ‚Üí piasek ‚Üí wƒôgiel</b>.</li>
        <li>Wlewaj mƒôtnƒÖ wodƒô powoli i obserwuj, jak siƒô klaruje.</li>
        <li>Mo≈ºesz powt√≥rzyƒá filtracjƒô 2‚Äì3 razy dla lepszego efektu.</li>
      </ul>
      <div class="warn">
        Uwaga: to filtr pokazowy. Nie gwarantuje wody pitnej.
        Do picia potrzebna jest dodatkowa dezynfekcja/uzdatnianie.
      </div>
      <div class="btnRow" style="margin-top:12px">
        <button class="btn" id="closeBtn">Zamknij</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const layers = [
    { id:"gravel", name:"≈ªwir", ico:"ü™®", desc:"du≈ºe zanieczyszczenia" },
    { id:"sand",   name:"Piasek", ico:"üèñÔ∏è", desc:"drobne czƒÖstki" },
    { id:"charcoal", name:"Wƒôgiel aktywny", ico:"‚ö´", desc:"zapach/kolor" },
    { id:"cotton", name:"Wata / filtr", ico:"üßª", desc:"zabezpiecza uj≈õcie" }
  ];
  const target = ["gravel","sand","charcoal"]; // d√≥≈Ç->g√≥ra

  const choicesEl = document.getElementById("choices");
  const slotsEl = document.getElementById("slots");
  const pickedCountEl = document.getElementById("pickedCount");
  const clarityNumEl = document.getElementById("clarityNum");
  const fillEl = document.getElementById("fill");
  const resultTitleEl = document.getElementById("resultTitle");
  const resultNoteEl = document.getElementById("resultNote");
  const checkBtn = document.getElementById("checkBtn");
  const resetBtn = document.getElementById("resetBtn");
  const howBtn = document.getElementById("howBtn");
  const pourBtn = document.getElementById("pourBtn");

  const modal = document.getElementById("modal");
  const closeBtn = document.getElementById("closeBtn");

  const beaker = document.getElementById("beaker");
  const mud = document.getElementById("mud");

  let picked = [];
  let clarity = 0;
  let hasChecked = false;

  function vibrate(pattern){
    try{ if (navigator.vibrate) navigator.vibrate(pattern); } catch(_) {}
  }

  function renderChoices(){
    choicesEl.innerHTML = "";
    layers.forEach(l => {
      const disabled = picked.includes(l.id) || picked.length>=3;
      const btn = document.createElement("div");
      btn.className = "chip" + (disabled ? " disabled" : "");
      btn.innerHTML = `
        <div class="left">
          <div class="ico">${l.ico}</div>
          <div>
            <div class="name">${l.name}</div>
            <div class="desc">${l.desc}</div>
          </div>
        </div>
        <div class="tag">${disabled ? "Dodano" : "Dodaj"}</div>
      `;
      btn.addEventListener("click", () => {
        if (picked.length >= 3) return;
        if (picked.includes(l.id)) return;
        picked.push(l.id);
        hasChecked = false;
        pourBtn.disabled = true;
        setClarity(0);
        resultTitleEl.textContent = "Zbuduj filtr";
        resultNoteEl.textContent = "Wynik pojawi siƒô po ‚ÄûSprawd≈∫‚Äù.";
        resetWaterVisual();
        renderAll();
      });
      choicesEl.appendChild(btn);
    });
  }

  function renderSlots(){
    slotsEl.innerHTML = "";
    for(let i=0;i<3;i++){
      const id = picked[i];
      const slot = document.createElement("div");
      slot.className = "slot";
      if(!id){
        slot.innerHTML = `<span>‚Äî wybierz warstwƒô (${i===0?"d√≥≈Ç":(i===1?"≈õrodek":"g√≥ra")}) ‚Äî</span><span></span>`;
      } else {
        const l = layers.find(x => x.id===id);
        slot.innerHTML = `<span><b>${i===0?"D√≥≈Ç":"Warstwa"}</b>: ${l.ico} ${l.name}</span>
                          <button class="remove" aria-label="Usu≈Ñ">‚úï</button>`;
        slot.querySelector(".remove").addEventListener("click", () => {
          picked.splice(i,1);
          hasChecked = false;
          pourBtn.disabled = true;
          setClarity(0);
          resultTitleEl.textContent = "Zbuduj filtr";
          resultNoteEl.textContent = "Wynik pojawi siƒô po ‚ÄûSprawd≈∫‚Äù.";
          resetWaterVisual();
          renderAll();
        });
      }
      slotsEl.appendChild(slot);
    }
  }

  function setClarity(value){
    clarity = Math.max(0, Math.min(100, value));
    clarityNumEl.textContent = String(clarity);
    fillEl.style.width = clarity + "%";
  }

  function evaluate(){
    const p = picked.slice(0,3);
    const sameOrder = p.join("|") === target.join("|");
    const correctSetCount = p.filter(x => target.includes(x)).length;

    let value = 0;
    if (sameOrder) value = 100;
    else if (correctSetCount === 3) value = 65;
    else if (correctSetCount === 2) value = 40;
    else if (correctSetCount === 1) value = 20;
    else value = 10;

    if (p.includes("cotton")) value = Math.max(5, value - 10);

    setClarity(value);
    hasChecked = true;
    pourBtn.disabled = false;

    if (sameOrder){
      resultTitleEl.textContent = "≈öwietnie! Filtr dzia≈Ça najlepiej";
      resultNoteEl.textContent = "Kolejno≈õƒá jest poprawna: ≈ºwir ‚Üí piasek ‚Üí wƒôgiel.";
      vibrate([70, 40, 70]); // –≤–∏–±—Ä–∞—Ü–∏—è –∑–∞ –∏–¥–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    } else if (correctSetCount === 3){
      resultTitleEl.textContent = "Dobrze, ale popraw kolejno≈õƒá";
      resultNoteEl.textContent = "Warstwy sƒÖ w≈Ça≈õciwe, jednak ich uk≈Çad ma znaczenie.";
    } else if (correctSetCount === 2){
      resultTitleEl.textContent = "Prawie! Brakuje jednej warstwy";
      resultNoteEl.textContent = "Spr√≥buj dodaƒá brakujƒÖcy materia≈Ç (≈ºwir/piasek/wƒôgiel).";
    } else {
      resultTitleEl.textContent = "Spr√≥buj jeszcze raz";
      resultNoteEl.textContent = "Najlepsza baza to: ≈ºwir ‚Üí piasek ‚Üí wƒôgiel.";
    }
  }

  function resetWaterVisual(){
    beaker.classList.remove("pouring");
    mud.style.opacity = "1"; // —Å—Ç–∞—Ä—Ç ‚Äî –æ—á–µ–Ω—å –º—É—Ç–Ω–æ
  }

  function pourWater(){
    if (!hasChecked) return;

    beaker.classList.remove("pouring");
    void beaker.offsetWidth;
    beaker.classList.add("pouring");

    const targetOpacity = 1 - (clarity / 100);
    const finalOpacity = Math.max(0.02, targetOpacity);

    setTimeout(() => {
      mud.style.opacity = String(finalOpacity);
      vibrate(25);
    }, 220);
  }

  function reset(){
    picked = [];
    setClarity(0);
    hasChecked = false;
    pourBtn.disabled = true;

    resultTitleEl.textContent = "Zbuduj filtr";
    resultNoteEl.textContent = "Wynik pojawi siƒô po ‚ÄûSprawd≈∫‚Äù.";
    resetWaterVisual();
    renderAll();
  }

  function renderAll(){
    renderChoices();
    renderSlots();
    pickedCountEl.textContent = String(picked.length);
    checkBtn.disabled = picked.length !== 3;
  }

  checkBtn.addEventListener("click", evaluate);
  resetBtn.addEventListener("click", reset);
  pourBtn.addEventListener("click", pourWater);

  howBtn.addEventListener("click", () => modal.classList.add("show"));
  closeBtn.addEventListener("click", () => modal.classList.remove("show"));
  modal.addEventListener("click", (e) => { if (e.target === modal) modal.classList.remove("show"); });

  renderAll();
  resetWaterVisual();
  setClarity(0);
})();
</script>
</body>
</html>

